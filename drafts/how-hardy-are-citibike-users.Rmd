---
title: "How hardy are New York's Citibike users?"
date: 2015-04-01
excerpt: "Comparing bike usage with weather data"
layout: post
published: no
status: draft
comments: true
tags: [Citibike, gender, dplyr, ggmap, weather]
---

```{r,set_knitr_opts,include=FALSE,echo=FALSE,message=FALSE,warning=FALSE}

require(dplyr)
require(magrittr)
require(lubridate)
require(ggmap)

knitr::opts_chunk$set(
  message = FALSE, 
  warning = FALSE,
  cache = FALSE
  )

knitr::opts_knit$set(
  root.dir = "~/Dropbox/newJamesShare/NewYorkBikes/" 
  )

setwd("~/Dropbox/newJamesShare/NewYorkBikes/")
```

Last year I played around a bit with the New York [Citibike](http://www.citibikenyc.com/system-data) data, and looked a little bit at the [different use patterns](http://ivyleavedtoadflax.github.io//citiBike-gender/) among among the sexes, and between [subscribers and ad hoc users](http://ivyleavedtoadflax.github.io//do-women-take-the-scenic-route/) of the service.

There are lots of other datasets available from New York which we can combine with our data; one of the most obvious of these is weather data. Data from weather stations all over the world are available from the [NCDC](http://www7.ncdc.noaa.gov/CDO/cdoselect.cmd?datasetabbv=GSOD&countryabbv=&georegionabbv=). 

I've worked with weather data from NCDC before, so already I have some scripts for tidying up this data. A full description of the data is available [here](http://www7.ncdc.noaa.gov/CDO/GSOD_DESC.txt), but I am mainly interested in:

|Variable name|Description|
|---|---|
|`STN...`|A unique numeric identifier for the station|
|`YEAR`|Year|
|`MODA`|Month and day|
|`TEMP`|Mean temperature for the day in degrees Fahrenheit to tenths.  Missing values are indicated by:= 9999.9**|
|`WDSP`|Mean wind speed for the day in knots to tenths.  Missing = 999.9**|
|`MXSPD`| Maximum sustained wind speed reported for the day in knots to tenths.  Missing = 999.9**|
|`GUST`|Maximum wind gust reported for the day in knots to tenths.  Missing = 999.9**|
|`MAX`|Maximum temperature reported during the day in Fahrenheit to tenths--time of max temp report varies by country and region, so this will sometimes not be the max for the calendar day.  Missing = 9999.9**|
|`MIN`|Minimum temperature reported during the day in Fahrenheit to tenths--time of min temp report varies by country and region, so this will sometimes not be the min for the calendar day.  Missing = 9999.9**|
|`PRCP`|Total precipitation (rain and/or melted snow) reported during the day in inches and hundredths; will usually not end with the midnight observation--i.e., may include latter part of previous day. .00 indicates no measurable precipitation (includes a trace). Missing = 99.99. Note: Many stations do not report '0' on days with no precipitation--therefore, '99.99' will often appear on these days. Also, for example, a station may only report a 6-hour amount for the period during which rain fell.See Flag field for source of data.**|
|`SNDP`|Snow depth in inches to tenths--last report for the day if reported more than once.  Missing = 999.9. Note:  Most stations do not report '0' on days with no snow on the ground--therefore, '999.9' will often appear on these days.**|
|`FRSHTT`|Indicators (1 = yes, 0 = no/not reported) for the occurrence during the day of: Fog ('F' - 1st digit). Rain or Drizzle ('R' - 2nd digit). Snow or Ice Pellets ('S' - 3rd digit). Hail ('H' - 4th digit). Thunder ('T' - 5th digit). Tornado or Funnel Cloud ('T' - 6th digit).**|

That's enough to be getting on with. Note that each variable has its associated quality control metadata included in the dataset.

I'll start by laoding the data and using `dplyr` to strip out the columns we are not interested in.

```{r,warning=FALSE,cache=TRUE}
library(dplyr)
library(magrittr)
library(lubridate)
library(ggmap)


ny_weather <- "ny_weather.txt" %>%
  read.csv %>%
  tbl_df %>%
  dplyr::mutate(
    date = ymd(YEARMODA),
    stn = STN...
    ) %>%
  dplyr::select(
    stn,WBAN,date,TEMP,
    WDSP,MXSPD,GUST,MAX,MIN,
    PRCP,SNDP,FRSHTT
    )

ny_weather 
```

Note that the station names are not included in the weather data, but they are available for download. Here I load the station names data, and join it to the weather data.

```{r}

station_names <- "stations.csv" %>%
  read.csv( 
  na.strings = ""
  )

met_stns <- ny_weather %>% 
  dplyr::mutate(
    USAF = stn
    ) %>%
  left_join(
    station_names
    ) %>%
  dplyr::mutate(
    name = STATION_NAME,
    lat = LAT %>% as.character %>% as.numeric %>% divide_by(1000),
    lon = LON %>% as.character %>% as.numeric %>% divide_by(1000),
    begin = ymd(BEGIN),
    end = ymd(END)
    ) %>%
  dplyr::select(
    stn,name,lat,lon,begin,end
    ) %>%
  distinct()

met_stns
```

Interestingly, after joining the `station_names` with `ny_weather`, I discovered minor discrepancies in the `lat` and `lon` of a few stations, and in the case of the MONTAUK station, the `stn` id had changed, in addition to have 3 different lat lons relating to three different measurment periods, all of which overlap! 


```{r}

met_stns_dup <- met_stns %>% 
  dplyr::group_by(
    name,stn,lat,lon,begin,end
    ) %>%
  dplyr::summarise(
    n = n()
    ) %>%
  dplyr::group_by(
    name, add = FALSE
    ) %>%
  dplyr::mutate(
    n_dup = n()
    ) %>%
  dplyr::filter(
    n_dup > 1,
    is.na(name) == FALSE
    )

met_stns_dup %>%
  dplyr::filter(
    name == "MONTAUK"
    )

```

As it turns out, these stations aren't too close to Manhatten island, so I'm not going to try to solve this problem any further, but it would make sense to only look at stations that have data in the period that we are interested in.

```{r}

load("bikes.RData")

met_stns %<>%
  dplyr::filter(
    end > min(bikes$starttime)
    )

```

Before producing any maps I find the centre point og all the bike stations which I'll use as the centre point of the maps.

```{r}

nybikes_db <- src_sqlite(
  "../../R/Citibike/nybikes.db"
  )

stns <- # convert db table to R dataframe
  tbl( # load a database table
    nybikes_db,
    sql("select * from stns")
    ) %>%
  collect

centre <- c(
  lon = mean(stns$lon),
  lat = mean(stns$lat)
  )

```


Now I use `ggmap` to call google map layers and overlay the weather station locations.

```{r}
  

nymap_12 <- get_map(
     centre, 
     scale = 2,
     zoom = 12,
     source = "google"
)

ggmap(
  nymap_12, 
  extent = 'device',
  legend="bottomright"
  ) +
  geom_point(
    data = met_stns,
    aes(
      x = lon,
      y = lat
      )
    )+
  geom_text(
    data = met_stns,
    aes(
      label = paste(name,"\n",stn)
      ),
    size = 4,
    col = "red",
    hjust = 0,
    vjust = 0
    )

```

```{r}

nymap_6 <- get_map(
  centre, 
  zoom = 10,
  source = "google"
  )

ggmap(
  nymap_6, 
  extent = 'device',
  legend="bottomright"
  ) + 
  geom_point(
    data = met_stns,
    aes(
      x = lon,
      y = lat
      )
    )+
  geom_text(
    data = met_stns,
    aes(
      label = paste(name,"\n",stn)
      ),
    size = 4,
    col = "red",
    hjust = 0,
    vjust = 0
    )

```

Insert plot of available data here!


```{r}

met_stns %>%
  dplyr::mutate(
    lon_diff = abs(lon - centre["lon"]),
    lat_diff = abs(lat - centre["lat"])
    ) %>% 
  dplyr::arrange(
    lat_diff,
    lon_diff
    )

celsius <- function(x) {
     round(
       ((x - 32) * 5)/9,
       2)
}

ny_weather <- ny_weather %>% 
  dplyr::filter(
    stn %in% c(997271,725053,997280)
    #STN... == 725053
    ) %>% 
  dplyr::mutate(
    stn = factor(stn),
    TEMP = ifelse((TEMP == 9999.9),NA,celsius(TEMP)),
    WDSP = ifelse((WDSP == 999.9),NA,WDSP * 1.85200),
    MXSPD =ifelse((MXSPD == 999.9),NA,MXSPD * 1.85200),
    GUST = ifelse((GUST == 999.9),NA,GUST),
    # It may be inportant to record later which values had asterisks
    MAX_star = ifelse(grepl("*",MAX),T,F),
    MAX = as.numeric(sub("\\*","",MAX)),
    MIN_star = ifelse(grepl("*",MIN),T,F),
    MIN = as.numeric(sub("\\*","",MAX)),
    # And also the letters with each PRCP entry
    PRCP = as.character(PRCP),
    PRCP = ifelse((PRCP == "99.99"),NA,PRCP),
    PRCP_letter = regmatches(PRCP,regexpr("[A-I]", PRCP, perl=TRUE)),
    PRCP = round(as.numeric(sub("[A-I]","",PRCP)) * 0.393700787,4),
    SNDP = ifelse((SNDP == 999.9),NA,SNDP)
    ) %>% 
  dplyr::select(
    -FRSHTT
    )

```

```{r}

ny_weather %>%
  dplyr::mutate(
    year = year(date),
    month = month(date)
    ) %>%
  dplyr::group_by(
    year,stn
    )  %>%
  ggplot(
    aes(
      x = date,
      y = TEMP,
      colour = stn
      )
    ) + 
  geom_path()+ 
  facet_wrap(
    ~stn, 
    ncol=1,
    scales = "free_y"
    ) +
  xlab("Year")+
  ylab(expression(Tempreature~(degree~C)))


ny_weather %>%
  dplyr::mutate(
    year = year(date),
    month = month(date)
    ) %>%
  dplyr::group_by(
    year,stn
    )  %>%
  ggplot(
    aes(
      x = date,
      y = PRCP,
      colour = stn
      )
    ) + 
  geom_path()+ 
  facet_wrap(
    ~stn, 
    ncol=1,
    scales = "free_y"
    ) +
  xlab("Year")+
  ylab(expression(Tempreature~(degree~C)))

ny_weather_long <- ny_weather %>%
  tidyr::gather(
    key,value,TEMP:SNDP
    )

ny_weather_long %>%
  ggplot(
    aes(
      x = date,
      y = value,
      colour = stn
      )
    ) + 
  geom_path()+ 
  facet_grid(
    key~stn, 
    #ncol=1,
    scales = "free_y"
    ) +
  xlab("Date")+
  ylab("Variable")

```


```{r,fig.width=10}

bla <- bikes %>% 
  dplyr::group_by(
    year = year(starttime),
    date = round_date(starttime,"day"),
    gender
    ) %>%
  dplyr::summarise(
    obs = n()
    )

# bla <- bla %>% 
#   dplyr::left_join(
#     ny_weather,
#     by = c("date" = "YEARMODA")
#     )

bla <- bla %>%
  left_join(
    ny_weather
    )

ggplot(
  data = bla,
  aes(
    x = TEMP,
    y = obs,
    colour = gender
    )
  )+
  geom_point(
    alpha = 0.3,
    size = 3
    )+
  geom_smooth(
    color = "darkblue"
    )+
  ylab("Journeys per day")+
  facet_wrap(
    ~gender,
    scale = "free"
    )

bla_long <-bla %>%
  dplyr::select(
    -MAX,-MIN
    ) %>%
  tidyr::gather(
    key,value,TEMP:SNDP
    )

ggplot(
  data = bla_long,
  aes(
    x = value,
    y = obs,
    colour = gender
    )
  )+
  geom_point(
    alpha = 0.3,
    size = 3
    )+
  geom_smooth(
    color = "darkblue"
    )+
  ylab("Journeys per day")+
  facet_wrap(
    key~gender,
    scale = "free"
    )


```


```{r,fig.width=10}

bla_rf <- bikes %>% 
  dplyr::group_by(
    #year = year(starttime),
    gender,
    age=cut(as.numeric(birth_year),5),
    #end_hash,
    wday(starttime),
    month(starttime),
    duration = as.numeric(stoptime-starttime),
    dur_cut = cut(duration,breaks = c(11,21,33))
    ) %>%
  dplyr::select(
    -duration
    ) %>%
  dplyr::summarise(
    obs = n()
    )

boxplot(split(bla_rf$obs,bla_rf$age))
boxplot(split(bla_rf$obs,bla_rf$dur_cut))

plot(density(as.numeric(bikes$stoptime-bikes$starttime)))

```


```{r}


ggplot(
  data = bla,
  aes(
    x = TEMP,
    y = obs,
    colour = gender
    )
  )+
  geom_point(
    alpha = 0.3,
    size = 3
    )+
  geom_smooth(
    color = "darkblue"
    )+
  ylab("Journeys per day")+
  facet_wrap(
    ~gender,
    scale = "free"
    )

```

```{r,fig.width=10}
ggplot(
  data = bla %>%
    dplyr::filter(
      PRCP > 0
      ),
  aes(
    x = PRCP,
    y = obs,
    colour = gender
    )
  )+
  geom_point(
    alpha = 0.3,
    size = 3
    )+
  geom_smooth(
    color = "darkblue"
    )+
  ylab("Journeys per day")+
  facet_wrap(
    ~gender
    )+
  scale_x_continuous(
    limits = c(0,1)
      )


# ggplot(
#   data = bla,
#   aes(
#     x = TEMP,
#     y = obs
#     )
#   )+
#   geom_point()+
#   geom_smooth()+
#   ylab("Journeys per day")+
#   facet_wrap(
#     ~name
#     )


```

```{r}
sessionInfo()
```


